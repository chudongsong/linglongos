<!DOCTYPE html>
<html lang="zh-CN">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>数据库模块测试</title>
	<style>
		body {
			font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
			max-width: 800px;
			margin: 0 auto;
			padding: 20px;
			line-height: 1.6;
		}

		h1 {
			text-align: center;
			margin-bottom: 30px;
		}

		.test-section {
			margin-bottom: 30px;
			padding: 15px;
			border: 1px solid #ddd;
			border-radius: 5px;
		}

		.test-title {
			font-weight: bold;
			margin-bottom: 10px;
		}

		.test-button {
			background-color: #4CAF50;
			border: none;
			color: white;
			padding: 10px 15px;
			text-align: center;
			text-decoration: none;
			display: inline-block;
			font-size: 16px;
			margin: 4px 2px;
			cursor: pointer;
			border-radius: 4px;
		}

		.log-container {
			background-color: #f5f5f5;
			padding: 10px;
			border-radius: 4px;
			margin-top: 10px;
			max-height: 200px;
			overflow-y: auto;
			font-family: monospace;
		}

		.log-entry {
			margin: 5px 0;
		}

		.log-success {
			color: green;
		}

		.log-error {
			color: red;
		}

		.log-info {
			color: blue;
		}
	</style>
</head>

<body>
	<h1>玲珑OS 数据库模块测试</h1>

	<div class="test-section">
		<div class="test-title">基本数据库操作测试</div>
		<button id="test-basic" class="test-button">运行基本测试</button>
		<div id="basic-log" class="log-container"></div>
	</div>

	<div class="test-section">
		<div class="test-title">数据库管理器测试</div>
		<button id="test-manager" class="test-button">运行管理器测试</button>
		<div id="manager-log" class="log-container"></div>
	</div>

	<div class="test-section">
		<div class="test-title">高级功能测试</div>
		<button id="test-advanced" class="test-button">运行高级测试</button>
		<div id="advanced-log" class="log-container"></div>
	</div>

	<div class="test-section">
		<div class="test-title">性能测试</div>
		<button id="test-performance" class="test-button">运行性能测试</button>
		<div id="performance-log" class="log-container"></div>
	</div>

	<script type="module">
		// 导入数据库模块
		import {
			DatabaseManager,
			DatabaseService,
			createDatabaseService,
			createAppDatabaseConfig
		} from './dist/index.es.js';

		// 日志记录函数
		function log(containerId, message, type = 'info') {
			const container = document.getElementById(containerId);
			const entry = document.createElement('div');
			entry.className = `log-entry log-${type}`;
			entry.textContent = message;
			container.appendChild(entry);
			container.scrollTop = container.scrollHeight;
		}

		// 基本数据库操作测试
		async function testBasicOperations() {
			const logId = 'basic-log';
			try {
				log(logId, '开始测试数据库基本功能...');

				// 创建数据库服务
				const dbService = createDatabaseService();

				// 使用辅助函数创建应用数据库配置
				const dbConfig = {
					name: 'test_basic_db',
					version: 1,
					stores: [
						{
							name: 'settings',
							keyPath: 'key',
							indexes: [
								{ name: 'category', keyPath: 'category' }
							]
						}
					]
				};

				// 初始化数据库
				log(logId, '初始化数据库...');
				const initialized = await dbService.init(dbConfig);
				if (!initialized) {
					log(logId, '初始化数据库失败', 'error');
					return;
				}
				log(logId, '数据库初始化成功', 'success');

				// 测试添加数据
				log(logId, '测试添加数据...');
				const settingData = {
					key: 'theme',
					value: 'dark',
					category: 'appearance',
				};
				const addResult = await dbService.add('settings', settingData);
				if (addResult.success) {
					log(logId, `添加数据成功: ${JSON.stringify(addResult.data)}`, 'success');
				} else {
					log(logId, `添加数据失败: ${addResult.error}`, 'error');
					return;
				}

				// 测试获取数据
				log(logId, '测试获取数据...');
				const getResult = await dbService.get('settings', 'theme');
				if (getResult.success) {
					log(logId, `获取数据成功: ${JSON.stringify(getResult.data)}`, 'success');
				} else {
					log(logId, `获取数据失败: ${getResult.error}`, 'error');
					return;
				}

				// 测试更新数据
				log(logId, '测试更新数据...');
				const updateResult = await dbService.update('settings', 'theme', { value: 'light' });
				if (updateResult.success) {
					log(logId, `更新数据成功: ${JSON.stringify(updateResult.data)}`, 'success');
				} else {
					log(logId, `更新数据失败: ${updateResult.error}`, 'error');
					return;
				}

				// 测试查询数据
				log(logId, '测试查询数据...');
				const queryResult = await dbService.query('settings', [
					{ field: 'category', operator: 'eq', value: 'appearance' },
				]);
				if (queryResult.success) {
					log(logId, `查询数据成功: ${JSON.stringify(queryResult.data)}`, 'success');
				} else {
					log(logId, `查询数据失败: ${queryResult.error}`, 'error');
					return;
				}

				// 测试批量添加数据
				log(logId, '测试批量添加数据...');
				const batchData = [
					{ key: 'language', value: 'zh-CN', category: 'localization' },
					{ key: 'fontSize', value: 14, category: 'appearance' },
					{ key: 'notifications', value: true, category: 'system' },
				];
				const batchAddResult = await dbService.addBatch('settings', batchData);
				if (batchAddResult.success) {
					log(logId, `批量添加数据成功: ${batchAddResult.data.length} 条记录`, 'success');
				} else {
					log(logId, `批量添加数据失败: ${batchAddResult.error}`, 'error');
					return;
				}

				// 测试获取所有数据
				log(logId, '测试获取所有数据...');
				const getAllResult = await dbService.getAll('settings');
				if (getAllResult.success) {
					log(logId, `获取所有数据成功: ${getAllResult.data.length} 条记录`, 'success');
				} else {
					log(logId, `获取所有数据失败: ${getAllResult.error}`, 'error');
					return;
				}

				// 测试统计数据
				log(logId, '测试统计数据...');
				const countResult = await dbService.count('settings');
				if (countResult.success) {
					log(logId, `统计数据成功, 共有记录: ${countResult.data}`, 'success');
				} else {
					log(logId, `统计数据失败: ${countResult.error}`, 'error');
					return;
				}

				// 测试删除数据
				log(logId, '测试删除数据...');
				const deleteResult = await dbService.delete('settings', 'notifications');
				if (deleteResult.success) {
					log(logId, '删除数据成功', 'success');
				} else {
					log(logId, `删除数据失败: ${deleteResult.error}`, 'error');
					return;
				}

				// 测试条件删除
				log(logId, '测试条件删除...');
				const deleteWhereResult = await dbService.deleteWhere('settings', [
					{ field: 'category', operator: 'eq', value: 'localization' },
				]);
				if (deleteWhereResult.success) {
					log(logId, `条件删除成功, 删除记录数: ${deleteWhereResult.count}`, 'success');
				} else {
					log(logId, `条件删除失败: ${deleteWhereResult.error}`, 'error');
					return;
				}

				// 再次获取所有数据，验证删除结果
				log(logId, '验证删除结果...');
				const verifyResult = await dbService.getAll('settings');
				if (verifyResult.success) {
					log(logId, `当前所有数据: ${verifyResult.data.length} 条记录`, 'success');
				} else {
					log(logId, `获取数据失败: ${verifyResult.error}`, 'error');
					return;
				}

				// 测试清空表
				log(logId, '测试清空表...');
				const clearResult = await dbService.clear('settings');
				if (clearResult.success) {
					log(logId, '清空表成功', 'success');
				} else {
					log(logId, `清空表失败: ${clearResult.error}`, 'error');
					return;
				}

				// 关闭数据库
				log(logId, '关闭数据库...');
				await dbService.close();
				log(logId, '数据库关闭成功', 'success');

				log(logId, '数据库基本功能测试完成', 'success');
			} catch (error) {
				log(logId, `测试过程中发生错误: ${error.message}`, 'error');
			}
		}

		// 数据库管理器测试
		async function testDatabaseManager() {
			const logId = 'manager-log';
			try {
				log(logId, '开始测试数据库管理器...');

				// 获取数据库管理器实例
				const dbManager = DatabaseManager.getInstance();

				// 注册多个数据库
				log(logId, '注册多个数据库...');
				await dbManager.registerDatabase({
					name: 'test_db1',
					version: 1,
					stores: [{ name: 'test_store', keyPath: 'id' }],
				});
				await dbManager.registerDatabase({
					name: 'test_db2',
					version: 1,
					stores: [{ name: 'test_store', keyPath: 'id' }],
				});

				// 检查数据库是否注册成功
				log(logId, '检查数据库是否注册成功...');
				const dbNames = dbManager.getAllDatabaseNames();
				log(logId, `已注册的数据库: ${dbNames.join(', ')}`, 'success');

				// 获取数据库实例
				log(logId, '获取数据库实例...');
				const db1Instance = dbManager.getDatabase('test_db1');
				log(logId, `获取数据库实例成功: ${db1Instance !== null}`, 'success');

				// 移除数据库
				log(logId, '移除数据库...');
				await dbManager.removeDatabase('test_db1');
				log(logId, `移除数据库后的列表: ${dbManager.getAllDatabaseNames().join(', ')}`, 'success');

				// 清空所有数据库
				log(logId, '清空所有数据库...');
				await dbManager.clearDatabases();
				log(logId, `清空后的数据库列表: ${dbManager.getAllDatabaseNames().join(', ')}`, 'success');

				log(logId, '数据库管理器测试完成', 'success');
			} catch (error) {
				log(logId, `测试过程中发生错误: ${error.message}`, 'error');
			}
		}

		// 高级功能测试
		async function testAdvancedFeatures() {
			const logId = 'advanced-log';
			try {
				log(logId, '开始测试数据库高级功能...');

				// 创建数据库服务
				const dbService = createDatabaseService();

				// 初始化数据库
				log(logId, '初始化数据库...');
				const initialized = await dbService.init({
					name: 'test_advanced_db',
					version: 1,
					stores: [
						{
							name: 'users',
							keyPath: 'id',
							indexes: [
								{ name: 'username', keyPath: 'username', unique: true },
								{ name: 'email', keyPath: 'email', unique: true },
								{ name: 'status', keyPath: 'status' },
							],
						},
						{
							name: 'posts',
							keyPath: 'id',
							indexes: [
								{ name: 'userId', keyPath: 'userId' },
								{ name: 'category', keyPath: 'category' },
								{ name: 'createdAt', keyPath: 'createdAt' },
							],
						},
					],
				});

				if (!initialized) {
					log(logId, '初始化数据库失败', 'error');
					return;
				}
				log(logId, '数据库初始化成功', 'success');

				// 测试事务
				log(logId, '测试事务操作...');
				const transactionResult = await dbService.transaction([
					{
						type: 'add',
						store: 'users',
						data: {
							id: 'user1',
							username: 'testuser',
							email: 'test@example.com',
							status: 'active',
							createdAt: Date.now(),
						},
					},
					{
						type: 'add',
						store: 'posts',
						data: {
							id: 'post1',
							userId: 'user1',
							title: '测试文章',
							content: '这是一篇测试文章',
							category: 'test',
							createdAt: Date.now(),
						},
					},
				]);

				if (transactionResult.success) {
					log(logId, '事务执行成功', 'success');
				} else {
					log(logId, `事务执行失败: ${transactionResult.error}`, 'error');
					return;
				}

				// 测试索引查询
				log(logId, '测试索引查询...');
				const indexQueryResult = await dbService.query('users', [
					{ field: 'username', operator: 'eq', value: 'testuser' },
				]);

				if (indexQueryResult.success && indexQueryResult.data.length > 0) {
					log(logId, `索引查询成功: ${JSON.stringify(indexQueryResult.data[0])}`, 'success');
				} else {
					log(logId, `索引查询失败: ${indexQueryResult.error || '未找到数据'}`, 'error');
					return;
				}

				// 测试关联查询
				log(logId, '测试关联查询...');
				const userId = indexQueryResult.data[0].id;
				const postsResult = await dbService.query('posts', [
					{ field: 'userId', operator: 'eq', value: userId },
				]);

				if (postsResult.success && postsResult.data.length > 0) {
					log(logId, `关联查询成功: 找到 ${postsResult.data.length} 篇文章`, 'success');
				} else {
					log(logId, `关联查询失败: ${postsResult.error || '未找到数据'}`, 'error');
					return;
				}

				// 关闭数据库
				log(logId, '关闭数据库...');
				await dbService.close();
				log(logId, '数据库关闭成功', 'success');

				log(logId, '数据库高级功能测试完成', 'success');
			} catch (error) {
				log(logId, `测试过程中发生错误: ${error.message}`, 'error');
			}
		}

		// 性能测试
		async function testPerformance() {
			const logId = 'performance-log';
			try {
				log(logId, '开始数据库性能测试...');

				// 创建数据库服务
				const dbService = createDatabaseService();

				// 初始化数据库
				log(logId, '初始化数据库...');
				const initialized = await dbService.init({
					name: 'test_performance_db',
					version: 1,
					stores: [
						{
							name: 'items',
							keyPath: 'id',
							indexes: [
								{ name: 'category', keyPath: 'category' },
								{ name: 'timestamp', keyPath: 'timestamp' },
							],
						},
					],
				});

				if (!initialized) {
					log(logId, '初始化数据库失败', 'error');
					return;
				}
				log(logId, '数据库初始化成功', 'success');

				// 生成测试数据
				const testDataCount = 1000;
				log(logId, `生成 ${testDataCount} 条测试数据...`);
				const testData = [];
				const categories = ['A', 'B', 'C', 'D', 'E'];

				for (let i = 0; i < testDataCount; i++) {
					testData.push({
						id: `item_${i}`,
						name: `测试项目 ${i}`,
						category: categories[i % categories.length],
						value: Math.random() * 1000,
						timestamp: Date.now() - Math.floor(Math.random() * 30 * 24 * 60 * 60 * 1000),
						data: Array(50).fill(0).map(() => Math.random().toString(36).substring(2)),
					});
				}

				// 测试批量写入性能
				log(logId, '测试批量写入性能...');
				const writeStartTime = performance.now();
				const batchSize = 100;

				for (let i = 0; i < testDataCount; i += batchSize) {
					const batch = testData.slice(i, i + batchSize);
					await dbService.addBatch('items', batch);
					log(logId, `已写入 ${Math.min(i + batchSize, testDataCount)}/${testDataCount} 条数据...`);
				}

				const writeEndTime = performance.now();
				const writeTime = writeEndTime - writeStartTime;
				log(logId, `批量写入 ${testDataCount} 条数据耗时: ${writeTime.toFixed(2)}ms (${(testDataCount / writeTime * 1000).toFixed(2)} 条/秒)`, 'success');

				// 测试读取性能
				log(logId, '测试读取性能...');
				const readStartTime = performance.now();
				const readResult = await dbService.getAll('items');
				const readEndTime = performance.now();
				const readTime = readEndTime - readStartTime;

				if (readResult.success) {
					log(logId, `读取 ${readResult.data.length} 条数据耗时: ${readTime.toFixed(2)}ms (${(readResult.data.length / readTime * 1000).toFixed(2)} 条/秒)`, 'success');
				} else {
					log(logId, `读取数据失败: ${readResult.error}`, 'error');
				}

				// 测试查询性能
				log(logId, '测试查询性能...');
				const queryStartTime = performance.now();
				const queryResult = await dbService.query('items', [
					{ field: 'category', operator: 'eq', value: 'A' },
				]);
				const queryEndTime = performance.now();
				const queryTime = queryEndTime - queryStartTime;

				if (queryResult.success) {
					log(logId, `查询 ${queryResult.data.length} 条数据耗时: ${queryTime.toFixed(2)}ms`, 'success');
				} else {
					log(logId, `查询数据失败: ${queryResult.error}`, 'error');
				}

				// 测试索引查询性能
				log(logId, '测试索引查询性能...');
				const indexQueryStartTime = performance.now();
				const indexQueryResult = await dbService.query('items', [
					{ field: 'category', operator: 'eq', value: 'B' },
				], { orderBy: { field: 'timestamp', direction: 'desc' } });
				const indexQueryEndTime = performance.now();
				const indexQueryTime = indexQueryEndTime - indexQueryStartTime;

				if (indexQueryResult.success) {
					log(logId, `索引查询 ${indexQueryResult.data.length} 条数据耗时: ${indexQueryTime.toFixed(2)}ms`, 'success');
				} else {
					log(logId, `索引查询数据失败: ${indexQueryResult.error}`, 'error');
				}

				// 测试删除性能
				log(logId, '测试删除性能...');
				const deleteStartTime = performance.now();
				await dbService.clear('items');
				const deleteEndTime = performance.now();
				const deleteTime = deleteEndTime - deleteStartTime;

				log(logId, `删除所有数据耗时: ${deleteTime.toFixed(2)}ms`, 'success');

				// 关闭数据库
				log(logId, '关闭数据库...');
				await dbService.close();
				log(logId, '数据库关闭成功', 'success');

				log(logId, '数据库性能测试完成', 'success');
			} catch (error) {
				log(logId, `测试过程中发生错误: ${error.message}`, 'error');
			}
		}

		// 绑定测试按钮事件
		document.getElementById('test-basic').addEventListener('click', testBasicOperations);
		document.getElementById('test-manager').addEventListener('click', testDatabaseManager);
		document.getElementById('test-advanced').addEventListener('click', testAdvancedFeatures);
		document.getElementById('test-performance').addEventListener('click', testPerformance);
	</script>
</body>

</html>