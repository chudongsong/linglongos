<!DOCTYPE html>
<html lang="zh-CN">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Google Auth 鉴权测试页面</title>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			min-height: 100vh;
			display: flex;
			align-items: center;
			justify-content: center;
			padding: 20px;
		}

		.container {
			background: white;
			border-radius: 16px;
			box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
			padding: 40px;
			max-width: 500px;
			width: 100%;
		}

		.header {
			text-align: center;
			margin-bottom: 30px;
		}

		.header h1 {
			color: #333;
			font-size: 28px;
			margin-bottom: 8px;
		}

		.header p {
			color: #666;
			font-size: 16px;
		}

		.step {
			margin-bottom: 30px;
			padding: 20px;
			border: 2px solid #f0f0f0;
			border-radius: 12px;
			transition: all 0.3s ease;
		}

		.step.active {
			border-color: #667eea;
			background: #f8f9ff;
		}

		.step.completed {
			border-color: #4caf50;
			background: #f1f8e9;
		}

		.step-title {
			font-size: 18px;
			font-weight: 600;
			color: #333;
			margin-bottom: 15px;
			display: flex;
			align-items: center;
		}

		.step-number {
			background: #667eea;
			color: white;
			width: 24px;
			height: 24px;
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 12px;
			margin-right: 10px;
		}

		.step.completed .step-number {
			background: #4caf50;
		}

		.qr-container {
			text-align: center;
			margin: 20px 0;
		}

		.qr-code {
			max-width: 200px;
			height: 200px;
			border: 2px solid #ddd;
			border-radius: 8px;
			margin: 0 auto 15px;
			display: none;
			align-items: center;
			justify-content: center;
			background: #f9f9f9;
		}

		.input-group {
			margin: 15px 0;
		}

		.input-group label {
			display: block;
			margin-bottom: 8px;
			font-weight: 500;
			color: #333;
		}

		.input-group input {
			width: 100%;
			padding: 12px 16px;
			border: 2px solid #ddd;
			border-radius: 8px;
			font-size: 16px;
			transition: border-color 0.3s ease;
		}

		.input-group input:focus {
			outline: none;
			border-color: #667eea;
		}

		.btn {
			background: #667eea;
			color: white;
			border: none;
			padding: 12px 24px;
			border-radius: 8px;
			font-size: 16px;
			font-weight: 500;
			cursor: pointer;
			transition: all 0.3s ease;
			width: 100%;
			margin: 10px 0;
		}

		.btn:hover {
			background: #5a6fd8;
			transform: translateY(-2px);
		}

		.btn:disabled {
			background: #ccc;
			cursor: not-allowed;
			transform: none;
		}

		.btn.secondary {
			background: #6c757d;
		}

		.btn.secondary:hover {
			background: #5a6268;
		}

		.status {
			padding: 12px 16px;
			border-radius: 8px;
			margin: 15px 0;
			font-weight: 500;
		}

		.status.success {
			background: #d4edda;
			color: #155724;
			border: 1px solid #c3e6cb;
		}

		.status.error {
			background: #f8d7da;
			color: #721c24;
			border: 1px solid #f5c6cb;
		}

		.status.info {
			background: #d1ecf1;
			color: #0c5460;
			border: 1px solid #bee5eb;
		}

		.panel-test {
			margin-top: 20px;
			padding: 20px;
			background: #f8f9fa;
			border-radius: 8px;
			display: none;
		}

		.panel-test.show {
			display: block;
		}

		.response-display {
			background: #f8f9fa;
			border: 1px solid #dee2e6;
			border-radius: 8px;
			padding: 15px;
			margin: 15px 0;
			font-family: 'Courier New', monospace;
			font-size: 12px;
			max-height: 200px;
			overflow-y: auto;
			white-space: pre-wrap;
		}

		.instructions {
			background: #fff3cd;
			border: 1px solid #ffeaa7;
			border-radius: 8px;
			padding: 15px;
			margin: 15px 0;
			color: #856404;
		}

		.instructions ol {
			margin-left: 20px;
		}

		.instructions li {
			margin: 5px 0;
		}

		/* 横向进度条样式（已取消显示） */
		.progressbar { display: none !important; }
		.progress-step { display: none !important; }
		.progress-line { display: none !important; }
	</style>
	<script src="./qrcode.min.js"></script>
</head>

<body>
	<div class="container">
		<div class="header">
			<h1>🔐 Google Auth 鉴权测试</h1>
			<p>测试 LingLongOS API 的 Google Authenticator 双重认证功能</p>
		</div>

		<!-- 顶部横向进度条已移除 -->

		<!-- 步骤 1: 获取绑定信息 -->
		<div class="step active" id="step1">
			<div class="step-title">
				<span class="step-number">1</span>
				获取 Google Authenticator 绑定信息
			</div>
			<div style="margin-bottom: 15px;">
				<button class="btn" onclick="getBindInfo()" id="getBindBtn" style="display: none;">🔗 获取Google Authenticator绑定信息</button>
			</div>

			<div class="qr-container">
				<div class="qr-code" id="qrCode">
					<span>点击上方按钮获取绑定信息</span>
				</div>
				<div id="configCompleteContainer" style="margin-top: 15px; text-align: center;">
					<button class="btn" onclick="markConfigComplete()" id="markCompleteBtn"
						style="background: #10b981; font-size: 14px;">
						✅ 已完成Google Auth配置
					</button>
					<div style="margin-top: 10px; font-size: 12px; color: #666;">
						点击此按钮表示您已在Google Authenticator中成功添加了账户
					</div>
				</div>
			</div>

			<div class="instructions" id="instructions" style="display: none;">
				<strong>📋 设置步骤：</strong>
				<ol>
					<li>在手机上打开 <strong>Google Authenticator</strong> 应用</li>
					<li>点击 <strong>"+"</strong> 号添加新账户</li>
					<li>选择 <strong>"扫描二维码"</strong> 或 <strong>"手动输入密钥"</strong></li>
					<li>扫描上方二维码、点击认证URL链接，或手动输入显示的密钥</li>
					<li>完成后，应用会显示 6 位数验证码，每30秒更新一次</li>
				</ol>
				<div
					style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 6px; border: 1px solid #ffeaa7;">
					<strong>💡 提示：</strong> 如果无法扫描二维码，可以点击"复制URL"按钮，然后在浏览器中打开该链接，系统会自动跳转到认证器应用。
				</div>
			</div>
		</div>

		<!-- 步骤 2: 验证令牌 -->
		<div class="step" id="step2" style="display: none;">
			<div class="step-title">
				<span class="step-number">2</span>
				验证 Google Authenticator 令牌
			</div>
			<div class="input-group">
				<label for="tokenInput">输入 Google Authenticator 中的 6 位数验证码：</label>
				<input type="text" id="tokenInput" placeholder="例如：123456" maxlength="6" pattern="[0-9]{6}">
			</div>
			<button class="btn" onclick="verifyToken()" disabled id="verifyBtn">验证令牌</button>
		</div>

		<!-- 步骤 3：测试接口步骤已移除 -->

		<!-- 状态显示 -->
		<div id="statusDisplay"></div>

		<!-- 响应显示 -->
		<div class="response-display" id="responseDisplay" style="display: none;"></div>
	</div>

	<script>
		const API_BASE = '/api/v1'
		// 移除未使用的 currentStep 状态变量，统一以 DOM 状态作为真实来源

		// DOM 元素缓存机制
		const domCache = new Map()

		/**
		 * getElement - 获取并缓存 DOM 元素
		 *
		 * @param id 元素 ID
		 * @returns 对应的 HTMLElement 或 null
		 */
		function getElement(id) {
			if (!domCache.has(id)) {
				domCache.set(id, document.getElementById(id))
			}
			return domCache.get(id)
		}

		/**
		 * initializePage - 页面初始化：检查是否已完成 Google Auth 配置
		 *
		 * 成功：跳过第一步，直接进入令牌验证步骤
		 * 失败或未配置：自动获取绑定信息并展示二维码
		 */
		async function initializePage() {
			try {
				const response = await fetch(`${API_BASE}/auth/google-auth-config`, {
					method: 'GET',
					credentials: 'include',
				})

				if (response.ok) {
					const data = await response.json()
					if (data.code === 200 && data.data.isConfigured) {
						showConfiguredState(data.data)
						return
					}
				}
			} catch (error) {
				console.log('检查配置状态失败，继续自动获取绑定信息:', error)
			}

			// 未配置或检查失败，自动获取绑定信息并展示二维码
			showStatus('📱 正在自动获取Google Authenticator绑定信息...', 'info')
			getBindInfo()
		}

		/**
		 * showConfiguredState - 显示“已配置”视图并进入第 2 步
		 *
		 * @param config 后端返回的配置状态（包含 configuredAt 等）
		 */
		/**
		 * showConfiguredState - 已授权直接进入下一阶段（隐藏步骤视图与进度条）
		 * @param {object} config 后端返回的配置状态对象
		 * @returns {void}
		 */
		function showConfiguredState(config) {
			const s1 = getElement('step1'); if (s1) s1.style.display = 'none';
			const s2 = getElement('step2'); if (s2) s2.style.display = 'none';
			showStatus('✅ 已检测到 Google Auth 已授权，正在进入下一阶段…', 'success')
			proceedToNextStage(config)
		}

		/**
		 * proceedToNextStage - 进入下一阶段程序（占位逻辑，按需替换为真实业务）
		 * @param {object} [config] 授权配置对象，可选
		 * @returns {void}
		 */
		function proceedToNextStage(config) {
			// TODO: 在此处接入你的真实业务流程（例如跳转页面或调用后端接口）
			// 这里提供基础提示，确保页面不会空白
			showStatus('🚀 系统已完成授权配置，后续业务已启动。', 'success')
		}

		/**
		 * showNormalConfigFlow - 显示正常的配置流程提示（第 1 步）
		 */
		function showNormalConfigFlow() {
			showStatus('📱 请点击按钮开始配置Google Authenticator。', 'info')
		}

		/**
		 * resetConfig - 重置 Google Auth 配置
		 *
		 * 成功：刷新页面，回到未配置流程
		 */
		async function resetConfig() {
			try {
				showStatus('🔄 正在重置配置...', 'info')

				const response = await fetch(`${API_BASE}/auth/google-auth-config/reset`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					credentials: 'include',
				})

				const data = await response.json()
				if (response.ok && data.code === 200) {
					showStatus('✅ 配置已重置，请重新配置Google Auth。', 'success')
					setTimeout(() => window.location.reload(), 1500)
				} else {
					showStatus(`❌ 重置配置失败：${data.message}`, 'error')
				}
			} catch (error) {
				showStatus(`❌ 请求失败：${error.message}`, 'error')
			}
		}

		/**
		 * updateStepStatus - 更新步骤视图状态（含横向进度条与显示控制）
		 *
		 * 逻辑：
		 * - 切换步骤容器的 active/completed 样式
		 * - 满足“必须完成上一项后，才显示下一项”的要求：
		 *   · 初始隐藏第 2、3 步；
		 *   · 当第 1 步完成 → 显示第 2 步；当第 2 步完成 → 显示第 3 步；
		 * - 同步更新顶部横向进度条的状态
		 *
		 * @param stepNum 步骤序号（1、2、3）
		 * @param status 状态：'active' | 'completed'
		 */
		function updateStepStatus(stepNum, status) {
		  const step = getElement(`step${stepNum}`)
		  // 切换容器样式
		  step.classList.remove('active', 'completed')
		  if (status === 'completed') {
		    step.classList.add('completed')
		  } else if (status === 'active') {
		    step.classList.add('active')
		  }
		
		  // 控制显示：只有前一步完成后才显示下一步
		  if (status === 'completed') {
		    const next = getElement(`step${stepNum + 1}`)
		    if (next) next.style.display = 'block'
		  }
		
		  // 当前步激活时确保可见
		  if (status === 'active') {
		    step.style.display = 'block'
		  }
		
		  // 初始化守卫：当第 1 步未完成时隐藏第 2 步
		  if (stepNum === 1 && status !== 'completed') {
		    const s2 = getElement('step2'); if (s2) s2.style.display = 'none'
		  }
		
		  // 移除横向进度条同步更新逻辑（进度条已隐藏）
		}

		/**
		 * showStatus - 统一状态提示展示（信息/成功/错误）
		 *
		 * @param message 提示文案
		 * @param type 状态类型：'info' | 'success' | 'error'
		 */
		function showStatus(message, type = 'info') {
			const statusDiv = getElement('statusDisplay')
			statusDiv.className = `status ${type}`
			statusDiv.textContent = message
			statusDiv.style.display = 'block'
		}

		/**
		 * showResponse - 展示后端原始响应，便于调试与核对
		 *
		 * @param data 任意可序列化对象
		 */
		function showResponse(data) {
			const responseDiv = getElement('responseDisplay')
			responseDiv.textContent = JSON.stringify(data, null, 2)
			responseDiv.style.display = 'block'
		}

		// 存储绑定信息（第 1 步结果）
		let bindingData = null

		/**
		 * getBindInfo - 第 1 步：获取 Google Authenticator 绑定信息并立即展示二维码
		 *
		 * 流程：请求服务端 → 保存绑定数据 → 生成二维码 → 展示引导与“已完成配置”按钮 → 进入第 2 步
		 */
		async function getBindInfo() {
			try {
				showStatus('🔄 正在获取Google Authenticator绑定信息...', 'info')

				const response = await fetch(`${API_BASE}/auth/google-auth-bind`, {
					method: 'GET',
					credentials: 'include',
				})

				const data = await response.json()
				showResponse(data)

				if (response.ok && data.code === 200) {
					bindingData = data.data

					// 已获取绑定二维码URL，直接渲染二维码
					generateQRCode()

					// 展示绑定详情（认证URL与密钥）
					showBindDetails()

					// 显示“已完成配置”按钮与说明
					getElement('configCompleteContainer').style.display = 'block'
					getElement('instructions').style.display = 'block'

					showStatus('✅ 绑定信息获取成功！请在 Google Authenticator 中添加账户。', 'success')

					updateStepStatus(1, 'completed')
					updateStepStatus(2, 'active')
					getElement('verifyBtn').disabled = false
				} else {
					showStatus(`❌ 获取绑定信息失败：${data.message}`, 'error')
				}
			} catch (error) {
				showStatus(`❌ 请求失败：${error.message}`, 'error')
				showResponse({ error: error.message })
			}
		}

		/**
		 * generateQRCode - 使用 QRCodeJS 库渲染绑定二维码
		 *
		 * 前置：bindingData.qrCodeUrl 存在
		 */
		function generateQRCode() {
			if (!bindingData) {
				showStatus('❌ 请先获取绑定信息', 'error')
				return
			}

			const container = getElement('qrCode')
			// 清空容器，避免重复生成导致叠加
			container.innerHTML = ''

			try {
				// 使用 qrcodejs（davidshimjs）库：通过构造函数渲染
				// 该库不支持 QRCode.toCanvas，而是使用 new QRCode(element, options)
				// @ts-ignore - QRCode 来自全局 CDN 脚本
				new QRCode(container, {
					text: bindingData.qrCodeUrl,
					width: 200,
					height: 200,
					colorDark: '#000000',
					colorLight: '#ffffff',
					// 防御：某些构建版本可能不存在 CorrectLevel；存在则使用较高容错
					// @ts-ignore
					correctLevel: typeof QRCode !== 'undefined' && QRCode.CorrectLevel ? QRCode.CorrectLevel.M : undefined,
				})

				showStatus('📱 二维码已生成！您可以使用Google Authenticator扫描。', 'success')
			} catch (err) {
				console.error('调用 QRCode 库失败:', err)
				showStatus('❌ 二维码库加载失败，请检查网络或稍后再试。', 'error')
			}

			container.style.display = 'block'
		}

		/**
		 * markConfigComplete - 标记已完成 Google Auth 配置
		 */
		async function markConfigComplete() {
			try {
				showStatus('🔄 正在保存配置状态...', 'info')

				const response = await fetch(`${API_BASE}/auth/google-auth-config/complete`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					credentials: 'include',
					body: JSON.stringify({ userId: 'user' }),
				})

				const data = await response.json()
				showResponse(data)

				if (response.ok && data.code === 200) {
					showStatus('✅ Google Auth配置状态已保存！下次启动时将跳过配置步骤。', 'success')
					getElement('configCompleteContainer').style.display = 'none'

					const confirmDiv = document.createElement('div')
					confirmDiv.style.cssText = 'margin-top: 15px; padding: 10px; background: #d1fae5; border: 1px solid #10b981; border-radius: 8px; color: #065f46; text-align: center; font-size: 14px;'
					confirmDiv.innerHTML = '🎉 配置已完成！系统已记录您的Google Auth设置状态。'
					getElement('qrCode').parentNode.appendChild(confirmDiv)
				} else {
					showStatus(`❌ 保存配置状态失败：${data.message}`, 'error')
				}
			} catch (error) {
				showStatus(`❌ 请求失败：${error.message}`, 'error')
				showResponse({ error: error.message })
			}
		}

		/**
		 * verifyToken - 第 2 步：验证 6 位数 TOTP 令牌
		 *
		 * 成功：进入第 3 步并显示“面板测试”区域
		 */
		async function verifyToken() {
			const token = getElement('tokenInput').value.trim()
			if (!token || token.length !== 6) {
				showStatus('请输入 6 位数验证码', 'error')
				return
			}

			try {
				showStatus('正在验证令牌...', 'info')

				const response = await fetch(`${API_BASE}/auth/google-auth-verify`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					credentials: 'include',
					body: JSON.stringify({ token }),
				})

				const data = await response.json()
				showResponse(data)

				if (response.ok && data.code === 200) {
					showStatus('令牌验证成功！配置完成，正在进入下一阶段…', 'success')
					updateStepStatus(2, 'completed')
					proceedToNextStage()
				} else {
					showStatus(`令牌验证失败：${data.message}`, 'error')
				}
			} catch (error) {
				showStatus(`请求失败：${error.message}`, 'error')
				showResponse({ error: error.message })
			}
		}

		// 第 3 步相关函数已移除（bindPanel/testProxy），如需后续功能请在下一阶段页面/模块中实现。

		/**
		 * showBindDetails - 展示绑定详情（认证URL与密钥），支持复制与显示/隐藏
		 *
		 * 前置：bindingData 包含 qrCodeUrl 与 secret
		 */
		function showBindDetails() {
			if (!bindingData) return
			const bindDetails = getElement('bindDetails')
			const authLink = getElement('authUrlLink')
			const secretText = getElement('secretText')

			authLink.href = bindingData.qrCodeUrl
			authLink.textContent = bindingData.qrCodeUrl
			secretText.textContent = bindingData.secret || ''
			bindDetails.style.display = 'block'
		}

		/**
		 * copyToClipboard - 复制文本到剪贴板，兼容部分浏览器环境
		 *
		 * @param text 要复制的文本
		 * @param label 用于提示的标签文案（如“认证URL”、“密钥”）
		 */
		async function copyToClipboard(text, label) {
			try {
				if (navigator.clipboard && window.isSecureContext) {
					await navigator.clipboard.writeText(text)
				} else {
					const ta = document.createElement('textarea')
					ta.value = text
					ta.style.position = 'fixed'
					ta.style.top = '-9999px'
					document.body.appendChild(ta)
					ta.focus()
					ta.select()
					const ok = document.execCommand('copy')
					document.body.removeChild(ta)
					if (!ok) throw new Error('浏览器不支持剪贴板写入')
				}
				showStatus(`📋 ${label}已复制到剪贴板`, 'success')
			} catch (err) {
				showStatus(`❌ 复制失败：${err instanceof Error ? err.message : String(err)}`, 'error')
			}
		}

		/**
		 * copyAuthUrl - 复制认证URL到剪贴板
		 */
		function copyAuthUrl() {
			if (!bindingData || !bindingData.qrCodeUrl) {
				showStatus('❌ 请先获取绑定信息', 'error')
				return
			}
			copyToClipboard(bindingData.qrCodeUrl, '认证URL')
		}

		/**
		 * copySecret - 复制密钥到剪贴板
		 */
		function copySecret() {
			if (!bindingData || !bindingData.secret) {
				showStatus('❌ 请先获取绑定信息', 'error')
				return
			}
			copyToClipboard(bindingData.secret, '密钥')
		}

		/**
		 * toggleSecret - 显示/隐藏密钥
		 */
		function toggleSecret() {
			const secretText = getElement('secretText')
			const secretMasked = getElement('secretMasked')
			const btn = getElement('toggleSecretBtn')
			const isHidden = secretText.style.display === 'none' || secretText.style.display === ''
			if (isHidden) {
				secretText.style.display = 'inline'
				secretMasked.style.display = 'none'
				btn.textContent = '隐藏密钥'
			} else {
				secretText.style.display = 'none'
				secretMasked.style.display = 'inline'
				btn.textContent = '显示密钥'
			}
		}

		// 页面加载时初始化
		window.addEventListener('DOMContentLoaded', initializePage);

		/**
		 * 初始化横向进度条可视状态
		 * - 初始仅激活第 1 步，隐藏第 2、3 步内容
		 */
		(function initProgressVisibility() {
		  const s2 = getElement('step2'); if (s2) s2.style.display = 'none'
		  // 第 3 步与进度条已移除，不再初始化
		})()

		// 监听令牌输入并控制按钮状态
		getElement('tokenInput').addEventListener('input', function (e) {
			const value = e.target.value.replace(/\D/g, '').slice(0, 6)
			e.target.value = value
			getElement('verifyBtn').disabled = value.length !== 6
		})

		// 回车快捷提交
		getElement('tokenInput').addEventListener('keypress', function (e) {
			if (e.key === 'Enter' && !getElement('verifyBtn').disabled) {
				verifyToken()
			}
		})
	</script>
</body>

</html>