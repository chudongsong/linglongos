<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Google Auth é‰´æƒæµ‹è¯•é¡µé¢</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      padding: 40px;
      max-width: 500px;
      width: 100%;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .header h1 {
      color: #333;
      font-size: 28px;
      margin-bottom: 8px;
    }

    .header p {
      color: #666;
      font-size: 16px;
    }

    .step {
      margin-bottom: 30px;
      padding: 20px;
      border: 2px solid #f0f0f0;
      border-radius: 12px;
      transition: all 0.3s ease;
    }

    .step.active {
      border-color: #667eea;
      background: #f8f9ff;
    }

    .step.completed {
      border-color: #4caf50;
      background: #f1f8e9;
    }

    .step-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
    }

    .step-number {
      background: #667eea;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      margin-right: 10px;
    }

    .step.completed .step-number {
      background: #4caf50;
    }

    .qr-container {
      text-align: center;
      margin: 20px 0;
    }

    .qr-code {
      max-width: 200px;
      height: 200px;
      border: 2px solid #ddd;
      border-radius: 8px;
      margin: 0 auto 15px;
      display: none;
      align-items: center;
      justify-content: center;
      background: #f9f9f9;
    }

    .secret-display {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      word-break: break-all;
      margin: 15px 0;
      display: none;
    }

    .input-group {
      margin: 15px 0;
    }

    .input-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #333;
    }

    .input-group input {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s ease;
    }

    .input-group input:focus {
      outline: none;
      border-color: #667eea;
    }

    .btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
      margin: 10px 0;
    }

    .btn:hover {
      background: #5a6fd8;
      transform: translateY(-2px);
    }

    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .btn.secondary {
      background: #6c757d;
    }

    .btn.secondary:hover {
      background: #5a6268;
    }

    .status {
      padding: 12px 16px;
      border-radius: 8px;
      margin: 15px 0;
      font-weight: 500;
    }

    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .panel-test {
      margin-top: 20px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      display: none;
    }

    .panel-test.show {
      display: block;
    }

    .response-display {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    .instructions {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      color: #856404;
    }

    .instructions ol {
      margin-left: 20px;
    }

    .instructions li {
      margin: 5px 0;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ” Google Auth é‰´æƒæµ‹è¯•</h1>
      <p>æµ‹è¯• LingLongOS API çš„ Google Authenticator åŒé‡è®¤è¯åŠŸèƒ½</p>
    </div>

    <!-- æ­¥éª¤ 1: è·å–ç»‘å®šä¿¡æ¯ -->
    <div class="step active" id="step1">
      <div class="step-title">
        <span class="step-number">1</span>
        è·å– Google Authenticator ç»‘å®šä¿¡æ¯
      </div>
      <div style="margin-bottom: 15px;">
        <button class="btn" onclick="getBindInfo()" id="getBindBtn">ğŸ”— è·å–Google Authenticatorç»‘å®šä¿¡æ¯</button>
      </div>

      <div class="qr-container">
        <div class="qr-code" id="qrCode">
          <span>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®è·å–ç»‘å®šä¿¡æ¯</span>
        </div>
        <div class="secret-display" id="secretDisplay"></div>
        <div id="configCompleteContainer" style="display: none; margin-top: 15px; text-align: center;">
          <button class="btn" onclick="markConfigComplete()" id="markCompleteBtn" style="background: #10b981; font-size: 14px;">
            âœ… å·²å®ŒæˆGoogle Authé…ç½®
          </button>
          <div style="margin-top: 10px; font-size: 12px; color: #666;">
            ç‚¹å‡»æ­¤æŒ‰é’®è¡¨ç¤ºæ‚¨å·²åœ¨Google Authenticatorä¸­æˆåŠŸæ·»åŠ äº†è´¦æˆ·
          </div>
        </div>
      </div>

      <div class="instructions" id="instructions" style="display: none;">
        <strong>ğŸ“‹ è®¾ç½®æ­¥éª¤ï¼š</strong>
        <ol>
          <li>åœ¨æ‰‹æœºä¸Šæ‰“å¼€ <strong>Google Authenticator</strong> åº”ç”¨</li>
          <li>ç‚¹å‡» <strong>"+"</strong> å·æ·»åŠ æ–°è´¦æˆ·</li>
          <li>é€‰æ‹© <strong>"æ‰«æäºŒç»´ç "</strong> æˆ– <strong>"æ‰‹åŠ¨è¾“å…¥å¯†é’¥"</strong></li>
          <li>æ‰«æä¸Šæ–¹äºŒç»´ç ã€ç‚¹å‡»è®¤è¯URLé“¾æ¥ï¼Œæˆ–æ‰‹åŠ¨è¾“å…¥æ˜¾ç¤ºçš„å¯†é’¥</li>
          <li>å®Œæˆåï¼Œåº”ç”¨ä¼šæ˜¾ç¤º 6 ä½æ•°éªŒè¯ç ï¼Œæ¯30ç§’æ›´æ–°ä¸€æ¬¡</li>
        </ol>
        <div
          style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 6px; border: 1px solid #ffeaa7;">
          <strong>ğŸ’¡ æç¤ºï¼š</strong> å¦‚æœæ— æ³•æ‰«æäºŒç»´ç ï¼Œå¯ä»¥ç‚¹å‡»"å¤åˆ¶URL"æŒ‰é’®ï¼Œç„¶ååœ¨æµè§ˆå™¨ä¸­æ‰“å¼€è¯¥é“¾æ¥ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è·³è½¬åˆ°è®¤è¯å™¨åº”ç”¨ã€‚
        </div>
      </div>
    </div>

    <!-- æ­¥éª¤ 2: éªŒè¯ä»¤ç‰Œ -->
    <div class="step" id="step2">
      <div class="step-title">
        <span class="step-number">2</span>
        éªŒè¯ Google Authenticator ä»¤ç‰Œ
      </div>
      <div class="input-group">
        <label for="tokenInput">è¾“å…¥ Google Authenticator ä¸­çš„ 6 ä½æ•°éªŒè¯ç ï¼š</label>
        <input type="text" id="tokenInput" placeholder="ä¾‹å¦‚ï¼š123456" maxlength="6" pattern="[0-9]{6}">
      </div>
      <button class="btn" onclick="verifyToken()" disabled id="verifyBtn">éªŒè¯ä»¤ç‰Œ</button>
    </div>

    <!-- æ­¥éª¤ 3: æµ‹è¯•å—ä¿æŠ¤æ¥å£ -->
    <div class="step" id="step3">
      <div class="step-title">
        <span class="step-number">3</span>
        æµ‹è¯•å—ä¿æŠ¤çš„ API æ¥å£
      </div>
      <div class="panel-test" id="panelTest">
        <h4>é¢æ¿ç»‘å®šæµ‹è¯•</h4>
        <div class="input-group">
          <label for="panelType">é¢æ¿ç±»å‹ï¼š</label>
          <select id="panelType" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px;">
            <option value="bt">å®å¡”é¢æ¿ (bt)</option>
            <option value="1panel">1Panel</option>
          </select>
        </div>
        <div class="input-group">
          <label for="panelUrl">é¢æ¿åœ°å€ï¼š</label>
          <input type="url" id="panelUrl" placeholder="http://panel.example.com:8888">
        </div>
        <div class="input-group">
          <label for="panelKey">API å¯†é’¥ï¼š</label>
          <input type="text" id="panelKey" placeholder="32ä½å­—ç¬¦çš„APIå¯†é’¥">
        </div>
        <button class="btn secondary" onclick="bindPanel()">ç»‘å®šé¢æ¿</button>

        <h4 style="margin-top: 20px;">ä»£ç†è¯·æ±‚æµ‹è¯•</h4>
        <div class="input-group">
          <label for="proxyUrl">è¯·æ±‚è·¯å¾„ï¼š</label>
          <input type="text" id="proxyUrl" placeholder="/api/panel/get_sys_info">
        </div>
        <div class="input-group">
          <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="checkbox" id="ignoreSslErrors" style="margin-right: 8px;">
            å¿½ç•¥SSLè¯ä¹¦éªŒè¯é”™è¯¯ï¼ˆé™ä½å®‰å…¨æ€§ï¼Œä»…ç”¨äºæµ‹è¯•ï¼‰
          </label>
          <small style="color: #666; margin-top: 5px; display: block;">
            âš ï¸ å¯ç”¨æ­¤é€‰é¡¹å°†è·³è¿‡SSLè¯ä¹¦éªŒè¯ï¼Œå¯èƒ½å­˜åœ¨å®‰å…¨é£é™©ã€‚ä»…åœ¨æµ‹è¯•ç¯å¢ƒæˆ–ä¿¡ä»»çš„ç½‘ç»œä¸­ä½¿ç”¨ã€‚
          </small>
        </div>
        <button class="btn secondary" onclick="testProxy()">ğŸ”„ æµ‹è¯•ä»£ç†è¯·æ±‚</button>
      </div>
    </div>

    <!-- çŠ¶æ€æ˜¾ç¤º -->
    <div id="statusDisplay"></div>

    <!-- å“åº”æ˜¾ç¤º -->
    <div class="response-display" id="responseDisplay" style="display: none;"></div>
  </div>

  <script>
    const API_BASE = '/api/v1';
    let currentStep = 1;

    // é¡µé¢åˆå§‹åŒ–
    async function initializePage() {
      try {
        // æ£€æŸ¥Google Authé…ç½®çŠ¶æ€
        const response = await fetch(`${API_BASE}/auth/google-auth-config`, {
          method: 'GET',
          credentials: 'include'
        });

        if (response.ok) {
          const data = await response.json();
          if (data.code === 200 && data.data.isConfigured) {
            // å·²é…ç½®ï¼Œè·³è¿‡ç¬¬ä¸€æ­¥
            showConfiguredState(data.data);
            return;
          }
        }
      } catch (error) {
        console.log('æ£€æŸ¥é…ç½®çŠ¶æ€å¤±è´¥ï¼Œç»§ç»­æ­£å¸¸æµç¨‹:', error);
      }
      
      // æœªé…ç½®æˆ–æ£€æŸ¥å¤±è´¥ï¼Œæ˜¾ç¤ºæ­£å¸¸çš„é…ç½®æµç¨‹
      showNormalConfigFlow();
    }

    // æ˜¾ç¤ºå·²é…ç½®çŠ¶æ€
    function showConfiguredState(config) {
      const step1 = document.getElementById('step1');
      step1.innerHTML = `
        <div class="step-title">
          <span class="step-number">1</span>
          Google Authenticator å·²é…ç½®
        </div>
        <div style="padding: 20px; background: #d1fae5; border: 1px solid #10b981; border-radius: 8px; color: #065f46;">
          <div style="text-align: center; margin-bottom: 15px;">
            <span style="font-size: 48px;">âœ…</span>
          </div>
          <div style="text-align: center; font-size: 16px; font-weight: 500; margin-bottom: 10px;">
            Google Auth å·²å®Œæˆé…ç½®
          </div>
          <div style="text-align: center; font-size: 14px; color: #047857;">
            é…ç½®æ—¶é—´ï¼š${new Date(config.configuredAt).toLocaleString()}
          </div>
          <div style="margin-top: 15px; text-align: center;">
            <button class="btn" onclick="resetConfig()" style="background: #f59e0b; font-size: 14px;">
              ğŸ”„ é‡æ–°é…ç½®
            </button>
          </div>
        </div>
      `;
      
      // æ›´æ–°æ­¥éª¤çŠ¶æ€
      updateStepStatus(1, 'completed');
      updateStepStatus(2, 'active');
      currentStep = 2;
      
      // å¯ç”¨ä»¤ç‰Œè¾“å…¥
      document.getElementById('verifyBtn').disabled = false;
      
      showStatus('âœ… ç³»ç»Ÿæ£€æµ‹åˆ°æ‚¨å·²å®ŒæˆGoogle Authé…ç½®ï¼Œå¯ä»¥ç›´æ¥è¿›è¡Œä»¤ç‰ŒéªŒè¯ã€‚', 'success');
    }

    // æ˜¾ç¤ºæ­£å¸¸é…ç½®æµç¨‹
    function showNormalConfigFlow() {
      // ä¿æŒåŸæœ‰çš„ç•Œé¢ä¸å˜
      showStatus('ğŸ“± è¯·ç‚¹å‡»æŒ‰é’®å¼€å§‹é…ç½®Google Authenticatorã€‚', 'info');
    }

    // é‡ç½®é…ç½®
    async function resetConfig() {
      try {
        showStatus('ğŸ”„ æ­£åœ¨é‡ç½®é…ç½®...', 'info');

        const response = await fetch(`${API_BASE}/auth/google-auth-config/reset`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'include'
        });

        const data = await response.json();
        if (response.ok && data.code === 200) {
          showStatus('âœ… é…ç½®å·²é‡ç½®ï¼Œè¯·é‡æ–°é…ç½®Google Authã€‚', 'success');
          // åˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºæ­£å¸¸é…ç½®æµç¨‹
          setTimeout(() => {
            window.location.reload();
          }, 1500);
        } else {
          showStatus(`âŒ é‡ç½®é…ç½®å¤±è´¥ï¼š${data.message}`, 'error');
        }
      } catch (error) {
        showStatus(`âŒ è¯·æ±‚å¤±è´¥ï¼š${error.message}`, 'error');
      }
    }

    // æ›´æ–°æ­¥éª¤çŠ¶æ€
    function updateStepStatus(stepNum, status) {
      const step = document.getElementById(`step${stepNum}`);
      step.classList.remove('active', 'completed');
      if (status === 'completed') {
        step.classList.add('completed');
      } else if (status === 'active') {
        step.classList.add('active');
      }
    }

    // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
    function showStatus(message, type = 'info') {
      const statusDiv = document.getElementById('statusDisplay');
      statusDiv.className = `status ${type}`;
      statusDiv.textContent = message;
      statusDiv.style.display = 'block';
    }

    // æ˜¾ç¤ºå“åº”æ•°æ®
    function showResponse(data) {
      const responseDiv = document.getElementById('responseDisplay');
      responseDiv.textContent = JSON.stringify(data, null, 2);
      responseDiv.style.display = 'block';
    }

    // å­˜å‚¨ç»‘å®šä¿¡æ¯
    let bindingData = null;

    // è·å–ç»‘å®šä¿¡æ¯
    async function getBindInfo() {
      try {
        showStatus('ğŸ”„ æ­£åœ¨è·å–Google Authenticatorç»‘å®šä¿¡æ¯...', 'info');

        const response = await fetch(`${API_BASE}/auth/google-auth-bind`, {
          method: 'GET',
          credentials: 'include'
        });

        const data = await response.json();
        showResponse(data);

        if (response.ok && data.code === 200) {
          // å­˜å‚¨ç»‘å®šæ•°æ®
          bindingData = data.data;

          // è§£æè®¤è¯URL
          const authUrl = data.data.qrCodeUrl;
          const urlParams = parseAuthUrl(authUrl);

          // æ˜¾ç¤ºå¯†é’¥ä¿¡æ¯
          const secretDisplay = document.getElementById('secretDisplay');
          secretDisplay.innerHTML = `
                        <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; border: 1px solid #bae6fd;">
                            <strong>ğŸ”‘ æ‰‹åŠ¨è¾“å…¥å¯†é’¥ï¼š</strong><br>
                            <code style="font-size: 16px; color: #0369a1; background: white; padding: 5px 8px; border-radius: 4px; display: inline-block; margin-top: 5px;">${data.data.secret}</code>
                            <div style="margin-top: 10px; font-size: 14px; color: #0369a1;">
                                <strong>è´¦æˆ·ä¿¡æ¯ï¼š</strong><br>
                                â€¢ æœåŠ¡åç§°ï¼š${urlParams.issuer || 'LingLongOS'}<br>
                                â€¢ è´¦æˆ·åç§°ï¼š${urlParams.label || 'user'}<br>
                                â€¢ ç®—æ³•ï¼š${urlParams.algorithm || 'SHA1'}<br>
                                â€¢ ä½æ•°ï¼š${urlParams.digits || '6'}<br>
                                â€¢ å‘¨æœŸï¼š${urlParams.period || '30'}ç§’
                            </div>
                        </div>
                    `;
          secretDisplay.style.display = 'block';

          // ç«‹å³ç”Ÿæˆå¹¶æ˜¾ç¤ºäºŒç»´ç 
          generateQRCode();

          // æ˜¾ç¤º"å·²å®Œæˆé…ç½®"æŒ‰é’®
          document.getElementById('configCompleteContainer').style.display = 'block';

          // æ˜¾ç¤ºè¯´æ˜
          document.getElementById('instructions').style.display = 'block';

          showStatus('âœ… ç»‘å®šä¿¡æ¯è·å–æˆåŠŸï¼è¯·åœ¨ Google Authenticator ä¸­æ·»åŠ è´¦æˆ·ã€‚', 'success');

          // æ›´æ–°æ­¥éª¤çŠ¶æ€
          updateStepStatus(1, 'completed');
          updateStepStatus(2, 'active');
          currentStep = 2;

          // å¯ç”¨ä»¤ç‰Œè¾“å…¥
          document.getElementById('verifyBtn').disabled = false;
        } else {
          showStatus(`âŒ è·å–ç»‘å®šä¿¡æ¯å¤±è´¥ï¼š${data.message}`, 'error');
        }
      } catch (error) {
        showStatus(`âŒ è¯·æ±‚å¤±è´¥ï¼š${error.message}`, 'error');
        showResponse({ error: error.message });
      }
    }

    // è§£æè®¤è¯URLå‚æ•°
    function parseAuthUrl(url) {
      try {
        const urlObj = new URL(url);
        const params = {};

        // è§£æè·¯å¾„ä¸­çš„æ ‡ç­¾å’Œå‘è¡Œè€…
        const pathParts = urlObj.pathname.split('/');
        if (pathParts.length > 1) {
          const labelPart = decodeURIComponent(pathParts[pathParts.length - 1]);
          if (labelPart.includes(':')) {
            const [issuer, label] = labelPart.split(':');
            params.issuer = issuer;
            params.label = label;
          } else {
            params.label = labelPart;
          }
        }

        // è§£ææŸ¥è¯¢å‚æ•°
        urlObj.searchParams.forEach((value, key) => {
          params[key] = value;
        });

        return params;
      } catch (error) {
        console.error('è§£æè®¤è¯URLå¤±è´¥:', error);
        return {};
      }
    }

    // ç”ŸæˆäºŒç»´ç 
    function generateQRCode() {
      if (!bindingData) {
        showStatus('âŒ è¯·å…ˆè·å–ç»‘å®šä¿¡æ¯', 'error');
        return;
      }

      const qrCode = document.getElementById('qrCode');
      qrCode.innerHTML = `
                <div style="padding: 20px; text-align: center;">
                    <div style="margin-bottom: 15px;">
                        <strong>ğŸ“± äºŒç»´ç ï¼ˆç‚¹å‡»é“¾æ¥åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šæ‰“å¼€ï¼‰</strong>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #e5e7eb; display: inline-block;">
                        <div style="font-family: monospace; font-size: 10px; line-height: 1; letter-spacing: 1px; color: #000;">
                            ${generateTextQR(bindingData.qrCodeUrl)}
                        </div>
                    </div>
                    <div style="margin-top: 15px;">
                        <a href="${bindingData.qrCodeUrl}" target="_blank" style="color: #667eea; text-decoration: none; font-weight: bold;">
                            ğŸ”— ç‚¹å‡»æ­¤é“¾æ¥åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šæ‰“å¼€
                        </a>
                    </div>
                </div>
            `;
      qrCode.style.display = 'block';

      showStatus('ğŸ“± äºŒç»´ç å·²ç”Ÿæˆï¼æ‚¨å¯ä»¥ä½¿ç”¨Google Authenticatoræ‰«ææˆ–ç‚¹å‡»é“¾æ¥ã€‚', 'success');
    }

    // ç”Ÿæˆæ–‡æœ¬äºŒç»´ç ï¼ˆç®€åŒ–ç‰ˆï¼‰
    function generateTextQR(text) {
      // è¿™æ˜¯ä¸€ä¸ªç®€åŒ–çš„æ–‡æœ¬äºŒç»´ç è¡¨ç¤º
      // åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œå»ºè®®ä½¿ç”¨ä¸“ä¸šçš„QRç åº“å¦‚qrcode.js
      const lines = [
        'â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ',
        'â–ˆ â–„â–„â–„â–„â–„ â–ˆâ–€â–ˆ â–ˆâ–„â–ˆâ–€â–€â–€â–„â–ˆ â–„â–„â–„â–„â–„ â–ˆ',
        'â–ˆ â–ˆ   â–ˆ â–ˆâ–€â–€â–€â–ˆ â–„â–„â–ˆâ–„â–„â–ˆ â–ˆ   â–ˆ â–ˆ',
        'â–ˆ â–ˆâ–„â–„â–„â–ˆ â–ˆâ–€ â–ˆâ–€â–€â–„â–ˆâ–€â–„â–€â–ˆ â–ˆâ–„â–„â–„â–ˆ â–ˆ',
        'â–ˆâ–„â–„â–„â–„â–„â–„â–„â–ˆâ–„â–€ â–€â–„â–ˆ â–ˆâ–„â–ˆâ–„â–„â–„â–„â–„â–„â–„â–ˆ',
        'â–ˆâ–„â–„â–ˆâ–„â–€â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–ˆ',
        'â–ˆ â–„â–„â–„â–„â–„ â–ˆâ–„â–ˆâ–„â–ˆâ–„â–ˆâ–„â–ˆâ–„â–ˆ â–„â–„â–„â–„â–„ â–ˆ',
        'â–ˆ â–ˆ   â–ˆ â–ˆâ–„â–„â–„â–„â–„â–„â–„â–„â–„â–ˆ â–ˆ   â–ˆ â–ˆ',
        'â–ˆ â–ˆâ–„â–„â–„â–ˆ â–ˆâ–„â–„â–„â–„â–„â–„â–„â–„â–„â–ˆ â–ˆâ–„â–„â–„â–ˆ â–ˆ',
        'â–ˆâ–„â–„â–„â–„â–„â–„â–„â–ˆâ–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–ˆ'
      ];
      return lines.join('<br>');
    }



    // æ ‡è®°Google Authé…ç½®å®Œæˆ
    async function markConfigComplete() {
      try {
        showStatus('ğŸ”„ æ­£åœ¨ä¿å­˜é…ç½®çŠ¶æ€...', 'info');

        const response = await fetch(`${API_BASE}/auth/google-auth-config/complete`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'include',
          body: JSON.stringify({ userId: 'user' })
        });

        const data = await response.json();
        showResponse(data);

        if (response.ok && data.code === 200) {
          showStatus('âœ… Google Authé…ç½®çŠ¶æ€å·²ä¿å­˜ï¼ä¸‹æ¬¡å¯åŠ¨æ—¶å°†è·³è¿‡é…ç½®æ­¥éª¤ã€‚', 'success');
          
          // éšè—é…ç½®å®ŒæˆæŒ‰é’®
          document.getElementById('configCompleteContainer').style.display = 'none';
          
          // å¯ä»¥é€‰æ‹©æ€§åœ°æ˜¾ç¤ºä¸€ä¸ªç¡®è®¤ä¿¡æ¯
          const confirmDiv = document.createElement('div');
          confirmDiv.style.cssText = 'margin-top: 15px; padding: 10px; background: #d1fae5; border: 1px solid #10b981; border-radius: 8px; color: #065f46; text-align: center; font-size: 14px;';
          confirmDiv.innerHTML = 'ğŸ‰ é…ç½®å·²å®Œæˆï¼ç³»ç»Ÿå·²è®°å½•æ‚¨çš„Google Authè®¾ç½®çŠ¶æ€ã€‚';
          document.getElementById('qrCode').parentNode.appendChild(confirmDiv);
        } else {
          showStatus(`âŒ ä¿å­˜é…ç½®çŠ¶æ€å¤±è´¥ï¼š${data.message}`, 'error');
        }
      } catch (error) {
        showStatus(`âŒ è¯·æ±‚å¤±è´¥ï¼š${error.message}`, 'error');
        showResponse({ error: error.message });
      }
    }

    // éªŒè¯ä»¤ç‰Œ
    async function verifyToken() {
      const token = document.getElementById('tokenInput').value.trim();

      if (!token || token.length !== 6) {
        showStatus('è¯·è¾“å…¥ 6 ä½æ•°éªŒè¯ç ', 'error');
        return;
      }

      try {
        showStatus('æ­£åœ¨éªŒè¯ä»¤ç‰Œ...', 'info');

        const response = await fetch(`${API_BASE}/auth/google-auth-verify`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'include',
          body: JSON.stringify({ token })
        });

        const data = await response.json();
        showResponse(data);

        if (response.ok && data.code === 200) {
          showStatus('ä»¤ç‰ŒéªŒè¯æˆåŠŸï¼ä¼šè¯å·²åˆ›å»ºï¼Œç°åœ¨å¯ä»¥è®¿é—®å—ä¿æŠ¤çš„æ¥å£ã€‚', 'success');

          // æ›´æ–°æ­¥éª¤çŠ¶æ€
          updateStepStatus(2, 'completed');
          updateStepStatus(3, 'active');
          currentStep = 3;

          // æ˜¾ç¤ºé¢æ¿æµ‹è¯•åŒºåŸŸ
          document.getElementById('panelTest').classList.add('show');
        } else {
          showStatus(`ä»¤ç‰ŒéªŒè¯å¤±è´¥ï¼š${data.message}`, 'error');
        }
      } catch (error) {
        showStatus(`è¯·æ±‚å¤±è´¥ï¼š${error.message}`, 'error');
        showResponse({ error: error.message });
      }
    }

    // ç»‘å®šé¢æ¿
    async function bindPanel() {
      const type = document.getElementById('panelType').value;
      const url = document.getElementById('panelUrl').value.trim();
      const key = document.getElementById('panelKey').value.trim();

      if (!url || !key) {
        showStatus('è¯·å¡«å†™å®Œæ•´çš„é¢æ¿ä¿¡æ¯', 'error');
        return;
      }

      try {
        showStatus('æ­£åœ¨ç»‘å®šé¢æ¿...', 'info');

        const response = await fetch(`${API_BASE}/proxy/bind-panel-key`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'include',
          body: JSON.stringify({ type, url, key })
        });

        const data = await response.json();
        showResponse(data);

        if (response.ok && data.code === 200) {
          showStatus('é¢æ¿ç»‘å®šæˆåŠŸï¼', 'success');
        } else {
          showStatus(`é¢æ¿ç»‘å®šå¤±è´¥ï¼š${data.message}`, 'error');
        }
      } catch (error) {
        showStatus(`è¯·æ±‚å¤±è´¥ï¼š${error.message}`, 'error');
        showResponse({ error: error.message });
      }
    }

    // æµ‹è¯•ä»£ç†è¯·æ±‚
    async function testProxy() {
      const panelType = document.getElementById('panelType').value;
      const proxyUrl = document.getElementById('proxyUrl').value.trim();
      const ignoreSslErrors = document.getElementById('ignoreSslErrors').checked;

      if (!proxyUrl) {
        showStatus('âŒ è¯·è¾“å…¥è¯·æ±‚è·¯å¾„', 'error');
        return;
      }

      try {
        showStatus('ğŸ”„ æ­£åœ¨æµ‹è¯•ä»£ç†è¯·æ±‚...', 'info');

        const requestBody = {
          url: proxyUrl,
          panelType: panelType,
          params: {}
        };

        // å¦‚æœå¯ç”¨äº†å¿½ç•¥SSLé”™è¯¯ï¼Œæ·»åŠ åˆ°è¯·æ±‚ä½“ä¸­
        if (ignoreSslErrors) {
          requestBody.ignoreSslErrors = true;
          showStatus('âš ï¸ æ­£åœ¨æµ‹è¯•ä»£ç†è¯·æ±‚ï¼ˆå·²å¿½ç•¥SSLè¯ä¹¦éªŒè¯ï¼‰...', 'info');
        }

        const response = await fetch(`${API_BASE}/proxy/request`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'include',
          body: JSON.stringify(requestBody)
        });

        const data = await response.json();
        showResponse(data);

        if (response.ok && data.code === 200) {
          showStatus('âœ… ä»£ç†è¯·æ±‚æˆåŠŸï¼', 'success');
        } else {
          // æ£€æŸ¥æ˜¯å¦ä¸ºSSLè¯ä¹¦é”™è¯¯
          if (data.message && data.message.includes('SSLè¯ä¹¦éªŒè¯å¤±è´¥')) {
            showStatus(`ğŸ”’ SSLè¯ä¹¦éªŒè¯å¤±è´¥ï¼š${data.message}`, 'error');

            // æ˜¾ç¤ºSSLé”™è¯¯çš„è¯¦ç»†ä¿¡æ¯å’Œå»ºè®®
            if (data.data && data.data.suggestion) {
              const errorDetails = document.createElement('div');
              errorDetails.style.cssText = 'margin-top: 10px; padding: 15px; background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; color: #92400e;';
              errorDetails.innerHTML = `
                                <strong>ğŸ’¡ è§£å†³å»ºè®®ï¼š</strong><br>
                                ${data.data.suggestion}<br><br>
                                <strong>ç¤ºä¾‹ï¼š</strong> å‹¾é€‰ä¸Šæ–¹çš„"å¿½ç•¥SSLè¯ä¹¦éªŒè¯é”™è¯¯"é€‰é¡¹ï¼Œç„¶åé‡æ–°æµ‹è¯•ã€‚
                            `;

              const statusDiv = document.getElementById('statusDisplay');
              statusDiv.appendChild(errorDetails);
            }
          } else {
            showStatus(`âŒ ä»£ç†è¯·æ±‚å¤±è´¥ï¼š${data.message}`, 'error');
          }
        }
      } catch (error) {
        showStatus(`âŒ è¯·æ±‚å¤±è´¥ï¼š${error.message}`, 'error');
        showResponse({ error: error.message });
      }
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    window.addEventListener('DOMContentLoaded', initializePage);

    // ç›‘å¬ä»¤ç‰Œè¾“å…¥
    document.getElementById('tokenInput').addEventListener('input', function (e) {
      const value = e.target.value.replace(/\D/g, '').slice(0, 6);
      e.target.value = value;

      const verifyBtn = document.getElementById('verifyBtn');
      verifyBtn.disabled = value.length !== 6;
    });

    // ç›‘å¬å›è½¦é”®
    document.getElementById('tokenInput').addEventListener('keypress', function (e) {
      if (e.key === 'Enter' && !document.getElementById('verifyBtn').disabled) {
        verifyToken();
      }
    });
  </script>
</body>

</html>
