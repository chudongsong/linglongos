<!DOCTYPE html>
<html lang="zh-CN">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Google Auth é‰´æƒæµ‹è¯•é¡µé¢</title>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}

		body {
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			min-height: 100vh;
			display: flex;
			align-items: center;
			justify-content: center;
			padding: 20px;
		}

		.container {
			background: white;
			border-radius: 16px;
			box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
			padding: 40px;
			max-width: 500px;
			width: 100%;
		}

		.header {
			text-align: center;
			margin-bottom: 30px;
		}

		.header h1 {
			color: #333;
			font-size: 28px;
			margin-bottom: 8px;
		}

		.header p {
			color: #666;
			font-size: 16px;
		}

		.step {
			margin-bottom: 30px;
			padding: 20px;
			border: 2px solid #f0f0f0;
			border-radius: 12px;
			transition: all 0.3s ease;
		}

		.step.active {
			border-color: #667eea;
			background: #f8f9ff;
		}

		.step.completed {
			border-color: #4caf50;
			background: #f1f8e9;
		}

		.step-title {
			font-size: 18px;
			font-weight: 600;
			color: #333;
			margin-bottom: 15px;
			display: flex;
			align-items: center;
		}

		.step-number {
			background: #667eea;
			color: white;
			width: 24px;
			height: 24px;
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 12px;
			margin-right: 10px;
		}

		.step.completed .step-number {
			background: #4caf50;
		}

		.qr-container {
			text-align: center;
			margin: 20px 0;
		}

		.qr-code {
			max-width: 200px;
			height: 200px;
			border: 2px solid #ddd;
			border-radius: 8px;
			margin: 0 auto 15px;
			display: none;
			align-items: center;
			justify-content: center;
			background: #f9f9f9;
		}

		.input-group {
			margin: 15px 0;
		}

		.input-group label {
			display: block;
			margin-bottom: 8px;
			font-weight: 500;
			color: #333;
		}

		.input-group input {
			width: 100%;
			padding: 12px 16px;
			border: 2px solid #ddd;
			border-radius: 8px;
			font-size: 16px;
			transition: border-color 0.3s ease;
		}

		.input-group input:focus {
			outline: none;
			border-color: #667eea;
		}

		.btn {
			background: #667eea;
			color: white;
			border: none;
			padding: 12px 24px;
			border-radius: 8px;
			font-size: 16px;
			font-weight: 500;
			cursor: pointer;
			transition: all 0.3s ease;
			width: 100%;
			margin: 10px 0;
		}

		.btn:hover {
			background: #5a6fd8;
			transform: translateY(-2px);
		}

		.btn:disabled {
			background: #ccc;
			cursor: not-allowed;
			transform: none;
		}

		.btn.secondary {
			background: #6c757d;
		}

		.btn.secondary:hover {
			background: #5a6268;
		}

		.status {
			padding: 12px 16px;
			border-radius: 8px;
			margin: 15px 0;
			font-weight: 500;
		}

		.status.success {
			background: #d4edda;
			color: #155724;
			border: 1px solid #c3e6cb;
		}

		.status.error {
			background: #f8d7da;
			color: #721c24;
			border: 1px solid #f5c6cb;
		}

		.status.info {
			background: #d1ecf1;
			color: #0c5460;
			border: 1px solid #bee5eb;
		}

		.panel-test {
			margin-top: 20px;
			padding: 20px;
			background: #f8f9fa;
			border-radius: 8px;
			display: none;
		}

		.panel-test.show {
			display: block;
		}

		.response-display {
			background: #f8f9fa;
			border: 1px solid #dee2e6;
			border-radius: 8px;
			padding: 15px;
			margin: 15px 0;
			font-family: 'Courier New', monospace;
			font-size: 12px;
			max-height: 200px;
			overflow-y: auto;
			white-space: pre-wrap;
		}

		.instructions {
			background: #fff3cd;
			border: 1px solid #ffeaa7;
			border-radius: 8px;
			padding: 15px;
			margin: 15px 0;
			color: #856404;
		}

		.instructions ol {
			margin-left: 20px;
		}

		.instructions li {
			margin: 5px 0;
		}

		/* æ¨ªå‘è¿›åº¦æ¡æ ·å¼ï¼ˆå·²å–æ¶ˆæ˜¾ç¤ºï¼‰ */
		.progressbar { display: none !important; }
		.progress-step { display: none !important; }
		.progress-line { display: none !important; }
	</style>
	<script src="./qrcode.min.js"></script>
</head>

<body>
	<div class="container">
		<div class="header">
			<h1>ğŸ” Google Auth é‰´æƒæµ‹è¯•</h1>
			<p>æµ‹è¯• LingLongOS API çš„ Google Authenticator åŒé‡è®¤è¯åŠŸèƒ½</p>
		</div>

		<!-- é¡¶éƒ¨æ¨ªå‘è¿›åº¦æ¡å·²ç§»é™¤ -->

		<!-- æ­¥éª¤ 1: è·å–ç»‘å®šä¿¡æ¯ -->
		<div class="step active" id="step1">
			<div class="step-title">
				<span class="step-number">1</span>
				è·å– Google Authenticator ç»‘å®šä¿¡æ¯
			</div>
			<div style="margin-bottom: 15px;">
				<button class="btn" onclick="getBindInfo()" id="getBindBtn" style="display: none;">ğŸ”— è·å–Google Authenticatorç»‘å®šä¿¡æ¯</button>
			</div>

			<div class="qr-container">
				<div class="qr-code" id="qrCode">
					<span>ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®è·å–ç»‘å®šä¿¡æ¯</span>
				</div>
				<div id="configCompleteContainer" style="margin-top: 15px; text-align: center;">
					<button class="btn" onclick="markConfigComplete()" id="markCompleteBtn"
						style="background: #10b981; font-size: 14px;">
						âœ… å·²å®ŒæˆGoogle Authé…ç½®
					</button>
					<div style="margin-top: 10px; font-size: 12px; color: #666;">
						ç‚¹å‡»æ­¤æŒ‰é’®è¡¨ç¤ºæ‚¨å·²åœ¨Google Authenticatorä¸­æˆåŠŸæ·»åŠ äº†è´¦æˆ·
					</div>
				</div>
			</div>

			<div class="instructions" id="instructions" style="display: none;">
				<strong>ğŸ“‹ è®¾ç½®æ­¥éª¤ï¼š</strong>
				<ol>
					<li>åœ¨æ‰‹æœºä¸Šæ‰“å¼€ <strong>Google Authenticator</strong> åº”ç”¨</li>
					<li>ç‚¹å‡» <strong>"+"</strong> å·æ·»åŠ æ–°è´¦æˆ·</li>
					<li>é€‰æ‹© <strong>"æ‰«æäºŒç»´ç "</strong> æˆ– <strong>"æ‰‹åŠ¨è¾“å…¥å¯†é’¥"</strong></li>
					<li>æ‰«æä¸Šæ–¹äºŒç»´ç ã€ç‚¹å‡»è®¤è¯URLé“¾æ¥ï¼Œæˆ–æ‰‹åŠ¨è¾“å…¥æ˜¾ç¤ºçš„å¯†é’¥</li>
					<li>å®Œæˆåï¼Œåº”ç”¨ä¼šæ˜¾ç¤º 6 ä½æ•°éªŒè¯ç ï¼Œæ¯30ç§’æ›´æ–°ä¸€æ¬¡</li>
				</ol>
				<div
					style="margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 6px; border: 1px solid #ffeaa7;">
					<strong>ğŸ’¡ æç¤ºï¼š</strong> å¦‚æœæ— æ³•æ‰«æäºŒç»´ç ï¼Œå¯ä»¥ç‚¹å‡»"å¤åˆ¶URL"æŒ‰é’®ï¼Œç„¶ååœ¨æµè§ˆå™¨ä¸­æ‰“å¼€è¯¥é“¾æ¥ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è·³è½¬åˆ°è®¤è¯å™¨åº”ç”¨ã€‚
				</div>
			</div>
		</div>

		<!-- æ­¥éª¤ 2: éªŒè¯ä»¤ç‰Œ -->
		<div class="step" id="step2" style="display: none;">
			<div class="step-title">
				<span class="step-number">2</span>
				éªŒè¯ Google Authenticator ä»¤ç‰Œ
			</div>
			<div class="input-group">
				<label for="tokenInput">è¾“å…¥ Google Authenticator ä¸­çš„ 6 ä½æ•°éªŒè¯ç ï¼š</label>
				<input type="text" id="tokenInput" placeholder="ä¾‹å¦‚ï¼š123456" maxlength="6" pattern="[0-9]{6}">
			</div>
			<button class="btn" onclick="verifyToken()" disabled id="verifyBtn">éªŒè¯ä»¤ç‰Œ</button>
		</div>

		<!-- æ­¥éª¤ 3ï¼šæµ‹è¯•æ¥å£æ­¥éª¤å·²ç§»é™¤ -->

		<!-- çŠ¶æ€æ˜¾ç¤º -->
		<div id="statusDisplay"></div>

		<!-- å“åº”æ˜¾ç¤º -->
		<div class="response-display" id="responseDisplay" style="display: none;"></div>
	</div>

	<script>
		const API_BASE = '/api/v1'
		// ç§»é™¤æœªä½¿ç”¨çš„ currentStep çŠ¶æ€å˜é‡ï¼Œç»Ÿä¸€ä»¥ DOM çŠ¶æ€ä½œä¸ºçœŸå®æ¥æº

		// DOM å…ƒç´ ç¼“å­˜æœºåˆ¶
		const domCache = new Map()

		/**
		 * getElement - è·å–å¹¶ç¼“å­˜ DOM å…ƒç´ 
		 *
		 * @param id å…ƒç´  ID
		 * @returns å¯¹åº”çš„ HTMLElement æˆ– null
		 */
		function getElement(id) {
			if (!domCache.has(id)) {
				domCache.set(id, document.getElementById(id))
			}
			return domCache.get(id)
		}

		/**
		 * initializePage - é¡µé¢åˆå§‹åŒ–ï¼šæ£€æŸ¥æ˜¯å¦å·²å®Œæˆ Google Auth é…ç½®
		 *
		 * æˆåŠŸï¼šè·³è¿‡ç¬¬ä¸€æ­¥ï¼Œç›´æ¥è¿›å…¥ä»¤ç‰ŒéªŒè¯æ­¥éª¤
		 * å¤±è´¥æˆ–æœªé…ç½®ï¼šè‡ªåŠ¨è·å–ç»‘å®šä¿¡æ¯å¹¶å±•ç¤ºäºŒç»´ç 
		 */
		async function initializePage() {
			try {
				const response = await fetch(`${API_BASE}/auth/google-auth-config`, {
					method: 'GET',
					credentials: 'include',
				})

				if (response.ok) {
					const data = await response.json()
					if (data.code === 200 && data.data.isConfigured) {
						showConfiguredState(data.data)
						return
					}
				}
			} catch (error) {
				console.log('æ£€æŸ¥é…ç½®çŠ¶æ€å¤±è´¥ï¼Œç»§ç»­è‡ªåŠ¨è·å–ç»‘å®šä¿¡æ¯:', error)
			}

			// æœªé…ç½®æˆ–æ£€æŸ¥å¤±è´¥ï¼Œè‡ªåŠ¨è·å–ç»‘å®šä¿¡æ¯å¹¶å±•ç¤ºäºŒç»´ç 
			showStatus('ğŸ“± æ­£åœ¨è‡ªåŠ¨è·å–Google Authenticatorç»‘å®šä¿¡æ¯...', 'info')
			getBindInfo()
		}

		/**
		 * showConfiguredState - æ˜¾ç¤ºâ€œå·²é…ç½®â€è§†å›¾å¹¶è¿›å…¥ç¬¬ 2 æ­¥
		 *
		 * @param config åç«¯è¿”å›çš„é…ç½®çŠ¶æ€ï¼ˆåŒ…å« configuredAt ç­‰ï¼‰
		 */
		/**
		 * showConfiguredState - å·²æˆæƒç›´æ¥è¿›å…¥ä¸‹ä¸€é˜¶æ®µï¼ˆéšè—æ­¥éª¤è§†å›¾ä¸è¿›åº¦æ¡ï¼‰
		 * @param {object} config åç«¯è¿”å›çš„é…ç½®çŠ¶æ€å¯¹è±¡
		 * @returns {void}
		 */
		function showConfiguredState(config) {
			const s1 = getElement('step1'); if (s1) s1.style.display = 'none';
			const s2 = getElement('step2'); if (s2) s2.style.display = 'none';
			showStatus('âœ… å·²æ£€æµ‹åˆ° Google Auth å·²æˆæƒï¼Œæ­£åœ¨è¿›å…¥ä¸‹ä¸€é˜¶æ®µâ€¦', 'success')
			proceedToNextStage(config)
		}

		/**
		 * proceedToNextStage - è¿›å…¥ä¸‹ä¸€é˜¶æ®µç¨‹åºï¼ˆå ä½é€»è¾‘ï¼ŒæŒ‰éœ€æ›¿æ¢ä¸ºçœŸå®ä¸šåŠ¡ï¼‰
		 * @param {object} [config] æˆæƒé…ç½®å¯¹è±¡ï¼Œå¯é€‰
		 * @returns {void}
		 */
		function proceedToNextStage(config) {
			// TODO: åœ¨æ­¤å¤„æ¥å…¥ä½ çš„çœŸå®ä¸šåŠ¡æµç¨‹ï¼ˆä¾‹å¦‚è·³è½¬é¡µé¢æˆ–è°ƒç”¨åç«¯æ¥å£ï¼‰
			// è¿™é‡Œæä¾›åŸºç¡€æç¤ºï¼Œç¡®ä¿é¡µé¢ä¸ä¼šç©ºç™½
			showStatus('ğŸš€ ç³»ç»Ÿå·²å®Œæˆæˆæƒé…ç½®ï¼Œåç»­ä¸šåŠ¡å·²å¯åŠ¨ã€‚', 'success')
		}

		/**
		 * showNormalConfigFlow - æ˜¾ç¤ºæ­£å¸¸çš„é…ç½®æµç¨‹æç¤ºï¼ˆç¬¬ 1 æ­¥ï¼‰
		 */
		function showNormalConfigFlow() {
			showStatus('ğŸ“± è¯·ç‚¹å‡»æŒ‰é’®å¼€å§‹é…ç½®Google Authenticatorã€‚', 'info')
		}

		/**
		 * resetConfig - é‡ç½® Google Auth é…ç½®
		 *
		 * æˆåŠŸï¼šåˆ·æ–°é¡µé¢ï¼Œå›åˆ°æœªé…ç½®æµç¨‹
		 */
		async function resetConfig() {
			try {
				showStatus('ğŸ”„ æ­£åœ¨é‡ç½®é…ç½®...', 'info')

				const response = await fetch(`${API_BASE}/auth/google-auth-config/reset`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					credentials: 'include',
				})

				const data = await response.json()
				if (response.ok && data.code === 200) {
					showStatus('âœ… é…ç½®å·²é‡ç½®ï¼Œè¯·é‡æ–°é…ç½®Google Authã€‚', 'success')
					setTimeout(() => window.location.reload(), 1500)
				} else {
					showStatus(`âŒ é‡ç½®é…ç½®å¤±è´¥ï¼š${data.message}`, 'error')
				}
			} catch (error) {
				showStatus(`âŒ è¯·æ±‚å¤±è´¥ï¼š${error.message}`, 'error')
			}
		}

		/**
		 * updateStepStatus - æ›´æ–°æ­¥éª¤è§†å›¾çŠ¶æ€ï¼ˆå«æ¨ªå‘è¿›åº¦æ¡ä¸æ˜¾ç¤ºæ§åˆ¶ï¼‰
		 *
		 * é€»è¾‘ï¼š
		 * - åˆ‡æ¢æ­¥éª¤å®¹å™¨çš„ active/completed æ ·å¼
		 * - æ»¡è¶³â€œå¿…é¡»å®Œæˆä¸Šä¸€é¡¹åï¼Œæ‰æ˜¾ç¤ºä¸‹ä¸€é¡¹â€çš„è¦æ±‚ï¼š
		 *   Â· åˆå§‹éšè—ç¬¬ 2ã€3 æ­¥ï¼›
		 *   Â· å½“ç¬¬ 1 æ­¥å®Œæˆ â†’ æ˜¾ç¤ºç¬¬ 2 æ­¥ï¼›å½“ç¬¬ 2 æ­¥å®Œæˆ â†’ æ˜¾ç¤ºç¬¬ 3 æ­¥ï¼›
		 * - åŒæ­¥æ›´æ–°é¡¶éƒ¨æ¨ªå‘è¿›åº¦æ¡çš„çŠ¶æ€
		 *
		 * @param stepNum æ­¥éª¤åºå·ï¼ˆ1ã€2ã€3ï¼‰
		 * @param status çŠ¶æ€ï¼š'active' | 'completed'
		 */
		function updateStepStatus(stepNum, status) {
		  const step = getElement(`step${stepNum}`)
		  // åˆ‡æ¢å®¹å™¨æ ·å¼
		  step.classList.remove('active', 'completed')
		  if (status === 'completed') {
		    step.classList.add('completed')
		  } else if (status === 'active') {
		    step.classList.add('active')
		  }
		
		  // æ§åˆ¶æ˜¾ç¤ºï¼šåªæœ‰å‰ä¸€æ­¥å®Œæˆåæ‰æ˜¾ç¤ºä¸‹ä¸€æ­¥
		  if (status === 'completed') {
		    const next = getElement(`step${stepNum + 1}`)
		    if (next) next.style.display = 'block'
		  }
		
		  // å½“å‰æ­¥æ¿€æ´»æ—¶ç¡®ä¿å¯è§
		  if (status === 'active') {
		    step.style.display = 'block'
		  }
		
		  // åˆå§‹åŒ–å®ˆå«ï¼šå½“ç¬¬ 1 æ­¥æœªå®Œæˆæ—¶éšè—ç¬¬ 2 æ­¥
		  if (stepNum === 1 && status !== 'completed') {
		    const s2 = getElement('step2'); if (s2) s2.style.display = 'none'
		  }
		
		  // ç§»é™¤æ¨ªå‘è¿›åº¦æ¡åŒæ­¥æ›´æ–°é€»è¾‘ï¼ˆè¿›åº¦æ¡å·²éšè—ï¼‰
		}

		/**
		 * showStatus - ç»Ÿä¸€çŠ¶æ€æç¤ºå±•ç¤ºï¼ˆä¿¡æ¯/æˆåŠŸ/é”™è¯¯ï¼‰
		 *
		 * @param message æç¤ºæ–‡æ¡ˆ
		 * @param type çŠ¶æ€ç±»å‹ï¼š'info' | 'success' | 'error'
		 */
		function showStatus(message, type = 'info') {
			const statusDiv = getElement('statusDisplay')
			statusDiv.className = `status ${type}`
			statusDiv.textContent = message
			statusDiv.style.display = 'block'
		}

		/**
		 * showResponse - å±•ç¤ºåç«¯åŸå§‹å“åº”ï¼Œä¾¿äºè°ƒè¯•ä¸æ ¸å¯¹
		 *
		 * @param data ä»»æ„å¯åºåˆ—åŒ–å¯¹è±¡
		 */
		function showResponse(data) {
			const responseDiv = getElement('responseDisplay')
			responseDiv.textContent = JSON.stringify(data, null, 2)
			responseDiv.style.display = 'block'
		}

		// å­˜å‚¨ç»‘å®šä¿¡æ¯ï¼ˆç¬¬ 1 æ­¥ç»“æœï¼‰
		let bindingData = null

		/**
		 * getBindInfo - ç¬¬ 1 æ­¥ï¼šè·å– Google Authenticator ç»‘å®šä¿¡æ¯å¹¶ç«‹å³å±•ç¤ºäºŒç»´ç 
		 *
		 * æµç¨‹ï¼šè¯·æ±‚æœåŠ¡ç«¯ â†’ ä¿å­˜ç»‘å®šæ•°æ® â†’ ç”ŸæˆäºŒç»´ç  â†’ å±•ç¤ºå¼•å¯¼ä¸â€œå·²å®Œæˆé…ç½®â€æŒ‰é’® â†’ è¿›å…¥ç¬¬ 2 æ­¥
		 */
		async function getBindInfo() {
			try {
				showStatus('ğŸ”„ æ­£åœ¨è·å–Google Authenticatorç»‘å®šä¿¡æ¯...', 'info')

				const response = await fetch(`${API_BASE}/auth/google-auth-bind`, {
					method: 'GET',
					credentials: 'include',
				})

				const data = await response.json()
				showResponse(data)

				if (response.ok && data.code === 200) {
					bindingData = data.data

					// å·²è·å–ç»‘å®šäºŒç»´ç URLï¼Œç›´æ¥æ¸²æŸ“äºŒç»´ç 
					generateQRCode()

					// å±•ç¤ºç»‘å®šè¯¦æƒ…ï¼ˆè®¤è¯URLä¸å¯†é’¥ï¼‰
					showBindDetails()

					// æ˜¾ç¤ºâ€œå·²å®Œæˆé…ç½®â€æŒ‰é’®ä¸è¯´æ˜
					getElement('configCompleteContainer').style.display = 'block'
					getElement('instructions').style.display = 'block'

					showStatus('âœ… ç»‘å®šä¿¡æ¯è·å–æˆåŠŸï¼è¯·åœ¨ Google Authenticator ä¸­æ·»åŠ è´¦æˆ·ã€‚', 'success')

					updateStepStatus(1, 'completed')
					updateStepStatus(2, 'active')
					getElement('verifyBtn').disabled = false
				} else {
					showStatus(`âŒ è·å–ç»‘å®šä¿¡æ¯å¤±è´¥ï¼š${data.message}`, 'error')
				}
			} catch (error) {
				showStatus(`âŒ è¯·æ±‚å¤±è´¥ï¼š${error.message}`, 'error')
				showResponse({ error: error.message })
			}
		}

		/**
		 * generateQRCode - ä½¿ç”¨ QRCodeJS åº“æ¸²æŸ“ç»‘å®šäºŒç»´ç 
		 *
		 * å‰ç½®ï¼šbindingData.qrCodeUrl å­˜åœ¨
		 */
		function generateQRCode() {
			if (!bindingData) {
				showStatus('âŒ è¯·å…ˆè·å–ç»‘å®šä¿¡æ¯', 'error')
				return
			}

			const container = getElement('qrCode')
			// æ¸…ç©ºå®¹å™¨ï¼Œé¿å…é‡å¤ç”Ÿæˆå¯¼è‡´å åŠ 
			container.innerHTML = ''

			try {
				// ä½¿ç”¨ qrcodejsï¼ˆdavidshimjsï¼‰åº“ï¼šé€šè¿‡æ„é€ å‡½æ•°æ¸²æŸ“
				// è¯¥åº“ä¸æ”¯æŒ QRCode.toCanvasï¼Œè€Œæ˜¯ä½¿ç”¨ new QRCode(element, options)
				// @ts-ignore - QRCode æ¥è‡ªå…¨å±€ CDN è„šæœ¬
				new QRCode(container, {
					text: bindingData.qrCodeUrl,
					width: 200,
					height: 200,
					colorDark: '#000000',
					colorLight: '#ffffff',
					// é˜²å¾¡ï¼šæŸäº›æ„å»ºç‰ˆæœ¬å¯èƒ½ä¸å­˜åœ¨ CorrectLevelï¼›å­˜åœ¨åˆ™ä½¿ç”¨è¾ƒé«˜å®¹é”™
					// @ts-ignore
					correctLevel: typeof QRCode !== 'undefined' && QRCode.CorrectLevel ? QRCode.CorrectLevel.M : undefined,
				})

				showStatus('ğŸ“± äºŒç»´ç å·²ç”Ÿæˆï¼æ‚¨å¯ä»¥ä½¿ç”¨Google Authenticatoræ‰«æã€‚', 'success')
			} catch (err) {
				console.error('è°ƒç”¨ QRCode åº“å¤±è´¥:', err)
				showStatus('âŒ äºŒç»´ç åº“åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åå†è¯•ã€‚', 'error')
			}

			container.style.display = 'block'
		}

		/**
		 * markConfigComplete - æ ‡è®°å·²å®Œæˆ Google Auth é…ç½®
		 */
		async function markConfigComplete() {
			try {
				showStatus('ğŸ”„ æ­£åœ¨ä¿å­˜é…ç½®çŠ¶æ€...', 'info')

				const response = await fetch(`${API_BASE}/auth/google-auth-config/complete`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					credentials: 'include',
					body: JSON.stringify({ userId: 'user' }),
				})

				const data = await response.json()
				showResponse(data)

				if (response.ok && data.code === 200) {
					showStatus('âœ… Google Authé…ç½®çŠ¶æ€å·²ä¿å­˜ï¼ä¸‹æ¬¡å¯åŠ¨æ—¶å°†è·³è¿‡é…ç½®æ­¥éª¤ã€‚', 'success')
					getElement('configCompleteContainer').style.display = 'none'

					const confirmDiv = document.createElement('div')
					confirmDiv.style.cssText = 'margin-top: 15px; padding: 10px; background: #d1fae5; border: 1px solid #10b981; border-radius: 8px; color: #065f46; text-align: center; font-size: 14px;'
					confirmDiv.innerHTML = 'ğŸ‰ é…ç½®å·²å®Œæˆï¼ç³»ç»Ÿå·²è®°å½•æ‚¨çš„Google Authè®¾ç½®çŠ¶æ€ã€‚'
					getElement('qrCode').parentNode.appendChild(confirmDiv)
				} else {
					showStatus(`âŒ ä¿å­˜é…ç½®çŠ¶æ€å¤±è´¥ï¼š${data.message}`, 'error')
				}
			} catch (error) {
				showStatus(`âŒ è¯·æ±‚å¤±è´¥ï¼š${error.message}`, 'error')
				showResponse({ error: error.message })
			}
		}

		/**
		 * verifyToken - ç¬¬ 2 æ­¥ï¼šéªŒè¯ 6 ä½æ•° TOTP ä»¤ç‰Œ
		 *
		 * æˆåŠŸï¼šè¿›å…¥ç¬¬ 3 æ­¥å¹¶æ˜¾ç¤ºâ€œé¢æ¿æµ‹è¯•â€åŒºåŸŸ
		 */
		async function verifyToken() {
			const token = getElement('tokenInput').value.trim()
			if (!token || token.length !== 6) {
				showStatus('è¯·è¾“å…¥ 6 ä½æ•°éªŒè¯ç ', 'error')
				return
			}

			try {
				showStatus('æ­£åœ¨éªŒè¯ä»¤ç‰Œ...', 'info')

				const response = await fetch(`${API_BASE}/auth/google-auth-verify`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					credentials: 'include',
					body: JSON.stringify({ token }),
				})

				const data = await response.json()
				showResponse(data)

				if (response.ok && data.code === 200) {
					showStatus('ä»¤ç‰ŒéªŒè¯æˆåŠŸï¼é…ç½®å®Œæˆï¼Œæ­£åœ¨è¿›å…¥ä¸‹ä¸€é˜¶æ®µâ€¦', 'success')
					updateStepStatus(2, 'completed')
					proceedToNextStage()
				} else {
					showStatus(`ä»¤ç‰ŒéªŒè¯å¤±è´¥ï¼š${data.message}`, 'error')
				}
			} catch (error) {
				showStatus(`è¯·æ±‚å¤±è´¥ï¼š${error.message}`, 'error')
				showResponse({ error: error.message })
			}
		}

		// ç¬¬ 3 æ­¥ç›¸å…³å‡½æ•°å·²ç§»é™¤ï¼ˆbindPanel/testProxyï¼‰ï¼Œå¦‚éœ€åç»­åŠŸèƒ½è¯·åœ¨ä¸‹ä¸€é˜¶æ®µé¡µé¢/æ¨¡å—ä¸­å®ç°ã€‚

		/**
		 * showBindDetails - å±•ç¤ºç»‘å®šè¯¦æƒ…ï¼ˆè®¤è¯URLä¸å¯†é’¥ï¼‰ï¼Œæ”¯æŒå¤åˆ¶ä¸æ˜¾ç¤º/éšè—
		 *
		 * å‰ç½®ï¼šbindingData åŒ…å« qrCodeUrl ä¸ secret
		 */
		function showBindDetails() {
			if (!bindingData) return
			const bindDetails = getElement('bindDetails')
			const authLink = getElement('authUrlLink')
			const secretText = getElement('secretText')

			authLink.href = bindingData.qrCodeUrl
			authLink.textContent = bindingData.qrCodeUrl
			secretText.textContent = bindingData.secret || ''
			bindDetails.style.display = 'block'
		}

		/**
		 * copyToClipboard - å¤åˆ¶æ–‡æœ¬åˆ°å‰ªè´´æ¿ï¼Œå…¼å®¹éƒ¨åˆ†æµè§ˆå™¨ç¯å¢ƒ
		 *
		 * @param text è¦å¤åˆ¶çš„æ–‡æœ¬
		 * @param label ç”¨äºæç¤ºçš„æ ‡ç­¾æ–‡æ¡ˆï¼ˆå¦‚â€œè®¤è¯URLâ€ã€â€œå¯†é’¥â€ï¼‰
		 */
		async function copyToClipboard(text, label) {
			try {
				if (navigator.clipboard && window.isSecureContext) {
					await navigator.clipboard.writeText(text)
				} else {
					const ta = document.createElement('textarea')
					ta.value = text
					ta.style.position = 'fixed'
					ta.style.top = '-9999px'
					document.body.appendChild(ta)
					ta.focus()
					ta.select()
					const ok = document.execCommand('copy')
					document.body.removeChild(ta)
					if (!ok) throw new Error('æµè§ˆå™¨ä¸æ”¯æŒå‰ªè´´æ¿å†™å…¥')
				}
				showStatus(`ğŸ“‹ ${label}å·²å¤åˆ¶åˆ°å‰ªè´´æ¿`, 'success')
			} catch (err) {
				showStatus(`âŒ å¤åˆ¶å¤±è´¥ï¼š${err instanceof Error ? err.message : String(err)}`, 'error')
			}
		}

		/**
		 * copyAuthUrl - å¤åˆ¶è®¤è¯URLåˆ°å‰ªè´´æ¿
		 */
		function copyAuthUrl() {
			if (!bindingData || !bindingData.qrCodeUrl) {
				showStatus('âŒ è¯·å…ˆè·å–ç»‘å®šä¿¡æ¯', 'error')
				return
			}
			copyToClipboard(bindingData.qrCodeUrl, 'è®¤è¯URL')
		}

		/**
		 * copySecret - å¤åˆ¶å¯†é’¥åˆ°å‰ªè´´æ¿
		 */
		function copySecret() {
			if (!bindingData || !bindingData.secret) {
				showStatus('âŒ è¯·å…ˆè·å–ç»‘å®šä¿¡æ¯', 'error')
				return
			}
			copyToClipboard(bindingData.secret, 'å¯†é’¥')
		}

		/**
		 * toggleSecret - æ˜¾ç¤º/éšè—å¯†é’¥
		 */
		function toggleSecret() {
			const secretText = getElement('secretText')
			const secretMasked = getElement('secretMasked')
			const btn = getElement('toggleSecretBtn')
			const isHidden = secretText.style.display === 'none' || secretText.style.display === ''
			if (isHidden) {
				secretText.style.display = 'inline'
				secretMasked.style.display = 'none'
				btn.textContent = 'éšè—å¯†é’¥'
			} else {
				secretText.style.display = 'none'
				secretMasked.style.display = 'inline'
				btn.textContent = 'æ˜¾ç¤ºå¯†é’¥'
			}
		}

		// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
		window.addEventListener('DOMContentLoaded', initializePage);

		/**
		 * åˆå§‹åŒ–æ¨ªå‘è¿›åº¦æ¡å¯è§†çŠ¶æ€
		 * - åˆå§‹ä»…æ¿€æ´»ç¬¬ 1 æ­¥ï¼Œéšè—ç¬¬ 2ã€3 æ­¥å†…å®¹
		 */
		(function initProgressVisibility() {
		  const s2 = getElement('step2'); if (s2) s2.style.display = 'none'
		  // ç¬¬ 3 æ­¥ä¸è¿›åº¦æ¡å·²ç§»é™¤ï¼Œä¸å†åˆå§‹åŒ–
		})()

		// ç›‘å¬ä»¤ç‰Œè¾“å…¥å¹¶æ§åˆ¶æŒ‰é’®çŠ¶æ€
		getElement('tokenInput').addEventListener('input', function (e) {
			const value = e.target.value.replace(/\D/g, '').slice(0, 6)
			e.target.value = value
			getElement('verifyBtn').disabled = value.length !== 6
		})

		// å›è½¦å¿«æ·æäº¤
		getElement('tokenInput').addEventListener('keypress', function (e) {
			if (e.key === 'Enter' && !getElement('verifyBtn').disabled) {
				verifyToken()
			}
		})
	</script>
</body>

</html>